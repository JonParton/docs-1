## Build a backend

<<<<<<< HEAD
Next, we will add data and auth capabilities to the app.

### Add data

Each of the `resource.ts` files is where you _define_ the corresponding backend resource. If you open up the `/amplify/data/resource.ts` file in your text editor, you will see some generated code already there:

```ts showLineNumbers title="amplify/data/resource.ts"
// amplify/data/resource.ts
=======
Next, we will add data and auth capabilities to the app.  In Amplify (Gen 2), the `resource.ts` files are where you _define_ the corresponding backend resource and details about it.

### Add data

`create-amplify` provides the scaffolding of a `/amplify/data/resource.ts` which is ready to deploy.

<Accordion title="See the complete /amplify/data/resources.ts">

If you open up the `/amplify/data/resource.ts` file in your text editor, you will see some generated code already there.

_Note: The steps defined in the code below do not require action to complete this quickstart. These notes are provided for every new app and will help you when you build your next app on your own._

```ts showLineNumbers title="amplify/data/resource.ts"
>>>>>>> main
import { type ClientSchema, a, defineData } from '@aws-amplify/backend';

/*== STEP 1 ===============================================================
The section below creates a Todo database table with a "content" field. Try
adding a new "isDone" field as a boolean. The authorization rules below
specify that owners, authenticated via your Auth resource, can "create",
"read", "update", and "delete" their own records. Public users,
authenticated via an API key, can only "read" records.
=========================================================================*/
const schema = a.schema({
  Todo: a
    .model({
      content: a.string()
    })
    .authorization([a.allow.owner(), a.allow.public().to(['read'])])
});

export type Schema = ClientSchema<typeof schema>;

export const data = defineData({
  schema,
  authorizationModes: {
    defaultAuthorizationMode: 'apiKey',
    // API Key is used for a.allow.public() rules
    apiKeyAuthorizationMode: {
      expiresInDays: 30
    }
  }
});

/*== STEP 2 ===============================================================
Go to your frontend source code. From your client-side code, generate a
Data client to make CRUDL requests to your table. (THIS SNIPPET WILL ONLY
WORK IN THE FRONTEND CODE FILE.)

Using JavaScript or Next.js React Server Components, Middleware, Server
Actions, or Pages Router? Review how to generate Data clients for those use
cases: https://docs.amplify.aws/gen2/build-a-backend/data/connect-to-API/
=========================================================================*/

/*
"use client"
import { generateClient } from "aws-amplify/data";
import { type Schema } from "@/amplify/data/resource";

const client = generateClient<Schema>() // use this Data client for CRUDL requests
*/

/*== STEP 3 ===============================================================
Fetch records from the database and use them in your frontend component.
(THIS SNIPPET WILL ONLY WORK IN THE FRONTEND CODE FILE.)
=========================================================================*/

/* For example, in a React component, you can use this snippet in your
  function's RETURN statement */
// const { data: todos } = client.models.Todo.list()

// return <ul>{todos.map(todo => <li key={todo.id}>{todo.content}</li>)}</ul>
```

<<<<<<< HEAD
<Accordion title='What is a schema?' eyebrow='Learn more'>
  The schema generated by Amplify is for a to-do app. A schema is a blueprint
  for how our app's data will be organized. Within the schema, we will define
  models which will correspond to a database table—`Todo` in the above code.
  Finally, we will define fields which are attributes that each data instance
=======
  The schema generated by Amplify is for a to-do app. A schema is a blueprint
  for how our app's data will be organized. Within the schema, we will define
  models that will correspond to a database table—`Todo` in the above code.
  Finally, we will define fields, which are attributes that each data instance
>>>>>>> main
  will have—in the generated code, the field is `content`. Each
  field will have a type attached to it—in the above examples, we are stating
  that the `content` field is a string.
</Accordion>

<<<<<<< HEAD
Let's make a quick change to our data model and add a `done` field. This will be a `boolean`, which can be set to `true` or `false` depending on whether our to-do list item is complete. Let's also add a priority field, which will be an `enum`. This field type will allow for just a few options to be stored—low, medium, or high.

We've removed the default comments to shorten the code below; however, you can choose to keep them for help in connecting to your frontend resources.

```diff title="amplify/data/resource.ts"
// amplify/data/resource.ts
=======

<b>Step 1:</b> Open `amplify/data/resource.ts` and update it to add a `done` field of type `boolean` and a `priority` field of `enum` with a value of `['low', 'medium', 'high']`. We've removed the default comments to shorten the code below for the next few examples.

```ts title="amplify/data/resource.ts"
>>>>>>> main
import { type ClientSchema, a, defineData } from '@aws-amplify/backend';

// ...

const schema = a.schema({
  Todo: a
    .model({
      content: a.string(),
<<<<<<< HEAD
+     done: a.boolean(),
+     priority: a.enum(['low', 'medium', 'high'])
=======
// highlight-start
      done: a.boolean(),
      priority: a.enum(['low', 'medium', 'high'])
// highlight-end
>>>>>>> main
    })
    .authorization([a.allow.owner(), a.allow.public().to(['read'])]),
});

<<<<<<< HEAD
export type Schema = ClientSchema<typeof schema>;

export const data = defineData({
  schema,
  authorizationModes: {
    defaultAuthorizationMode: 'apiKey',
    // API Key is used for a.allow.public() rules
    apiKeyAuthorizationMode: {
      expiresInDays: 30,
    },
  },
});

// ...
```

Once you save your changes to the data model, your changes will be deployed in seconds within your cloud sandbox.

Our Todo data model also has authorization set up. Our model has the `authorization` method chained to it, which you can add rules to. In our example, we are allowing an owner, or the person who creates the Todo instance, to perform all actions on the data they own. We are also allowing all page viewers, including unauthenticated users, to read data. These can be modified; for example, we could remove the `.to(['read'])` and allow all visitors to perform all actions on data. We could also add permissions for signed-in users or users who belong to user groups such as `Admin`. You can learn more about all options for authorization in the [customize your auth rules](/gen2/build-a-backend/data/customize-authz/) section of the docs.

Let's remove public access.

```js
.authorization([a.allow.owner()]),
```

Then, you will see the `defineData` function, which has our schema and authorization configuration passed in as arguments. We have an `apiKey` set up to enable public access. Let's change our `defaultAuthorizationMode` to `userPool` instead so that the default is to use user authentication.

```js
=======
// ...
```

Once you save your changes to the data model, they will be deployed in seconds to your cloud sandbox.


The `Todo` data model is defined with authorization rules to allow the person who creates the Todo instance (the owner), to perform all actions on the data they own.  We are also allowing all page viewers, including unauthenticated users, to read data.

<Callout>
**Note:** These authorization rules can be modified using a chain of methods as defined by default. For example, we could remove the `.to(['read'])` and allow all visitors to perform all actions on data or add permissions for signed-in users or users who belong to user groups such as `Admin`. You can learn more about all options for authorization in the [customize your auth rules](/gen2/build-a-backend/data/customize-authz/) section of the docs.
</Callout>

<b>Step 2:</b> Remove public access by deleting the `a.allow.public().to(['read'])` authorization rule. Your authorization rule will look like the code below:

```js title="amplify/data/resource.ts"
// ...

.authorization([a.allow.owner()]),

// ...
```

Below the schema declaration, you will see the `defineData` function which receives our schema and authorization configuration as arguments.  The default configuration is for an `apiKey` to enable public access.

<b>Step 3:</b> Update the `defaultAuthorizationMode` to `userPool` so that the default is to use user authentication.

```ts title="amplify/data/resource.ts"
// ...

>>>>>>> main
export const data = defineData({
  schema,
  authorizationModes: {
    defaultAuthorizationMode: 'userPool'
  }
});
```

<<<<<<< HEAD
The definitions are imported and set in the `backend` file. We will not need to change anything in this file right now, but you can see its contents, which define a backend with our data and auth configurations from their respective files.

```ts title="amplify/backend.ts"
// amplify/backend.ts
import { defineBackend } from '@aws-amplify/backend';
import { auth } from './auth/resource.js';
import { data } from './data/resource.js';

defineBackend({
  auth,
  data
});
```

### Add authentication

Now let's work on our authentication configuration. Similar to the `data/resource.ts` we just worked on, the `auth/resource.ts` file has code to define our authentication configuration. In this case, setting the authentication method to log in with email.

```ts title="amplify/auth/resource.ts"
// amplify/auth/resource.ts
=======

### Add authentication

Now let's work on our authentication configuration. Similar to the `data/resource.ts` we just worked on, the `auth/resource.ts` file has code to define our authentication configuration. In this case, we are setting the authentication method to log in with email.

<Accordion title="See the complete /amplify/auth/resources.ts">
```ts title="amplify/auth/resource.ts"
>>>>>>> main
import { defineAuth } from '@aws-amplify/backend';

/**
 * Define and configure your auth resource
 * When used alongside data, it is automatically configured as an auth provider for data
 * @see https://docs.amplify.aws/gen2/build-a-backend/auth
 */
export const auth = defineAuth({
  loginWith: {
    email: true,
    // add social providers
    externalProviders: {
      /**
       * first, create your secrets using `amplify sandbox secret`
       * then, import `secret` from `@aws-amplify/backend`
       * @see https://docs.amplify.aws/gen2/deploy-and-host/sandbox-environments/features/#setting-secrets
       */
      // loginWithAmazon: {
      //   clientId: secret('LOGINWITHAMAZON_CLIENT_ID'),
      //   clientSecret: secret('LOGINWITHAMAZON_CLIENT_SECRET'),
      // }
    }
  },
  /**
   * enable multifactor authentication
   * @see https://docs.amplify.aws/gen2/build-a-backend/auth/manage-mfa
   */
  // multifactor: {
  //   mode: 'OPTIONAL',
  //   sms: {
  //     smsMessage: (code) => `Your verification code is ${code}`,
  //   },
  // },
  userAttributes: {
    /** request additional attributes for your app's users */
    // profilePicture: {
    //   mutable: true,
    //   required: false,
    // },
  }
});
```
<<<<<<< HEAD

Let's customize the verification email for our app. We can add a subject line by defining an object with email authentication properties. Again, we have removed comments for brevity.

```diff title="amplify/auth/resource.ts"
=======
</Accordion>

Let's customize the subject of the verification email sent to users after they sign up for our app. There is only one step to complete.

Open `amplify/auth/resource.ts` and update it to add a subject line by defining an object with email authentication properties referencing the code below:

```ts title="amplify/auth/resource.ts"
>>>>>>> main
// amplify/auth/resource.ts
import { defineAuth } from '@aws-amplify/backend';

export const auth = defineAuth({
  loginWith: {
<<<<<<< HEAD
-   email: true,
+   email: {
+     verificationEmailSubject: 'Welcome! Verify your email!'
+   },
    // add social providers
    externalProviders: {
    }
  }
});
```
=======
// highlight-start
   email: {
     verificationEmailSubject: 'Welcome! Verify your email!'
   },
// highlight-end
  }
});
```


<Callout info>The Data and Auth resource files are imported into the `amplify/backend.ts` file which serves as the entrypoint to the Amplify backend for all resources used in this app. It is shown below, but there are no modifications needed to complete this quickstart.</Callout>

```ts title="amplify/backend.ts"
import { defineBackend } from '@aws-amplify/backend';
import { auth } from './auth/resource';
import { data } from './data/resource';

defineBackend({
  auth,
  data
});
```
>>>>>>> main
